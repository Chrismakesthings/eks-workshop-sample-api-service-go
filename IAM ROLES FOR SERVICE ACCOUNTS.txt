#IAM ROLES FOR SERVICE ACCOUNTS
#The IAM roles for service accounts feature is available on new Amazon EKS Kubernetes version 1.14 clusters, and clusters that were updated
# to versions 1.14 or 1.13 on or after September 3rd, 2019.

kubectl version --short

aws --version

#Retrieve OpenID Connect issuer URL:

aws eks describe-cluster --name eksworkshop-eksctl --query cluster.identity.oidc.issuer --output text

#Check your eksctl version that your eksctl version is at least 0.5.1

eksctl version

#Create your OIDC identity provider for your cluster

eksctl utils associate-iam-oidc-provider --cluster eksworkshop-eksctl --approve

#Let’s start by finding the ARN for the “AmazonS3ReadOnlyAccess” policy

aws iam list-policies --query 'Policies[?PolicyName==`AmazonS3ReadOnlyAccess`].Arn'

#Now you will create a IAM role bound to a service account with read-only access to S3

eksctl create iamserviceaccount \
    --name iam-test \
    --namespace default \
    --cluster eksworkshop-eksctl \
    --attach-policy-arn arn:aws:iam::aws:policy/AmazonS3ReadOnlyAccess \
    --approve \
    --override-existing-serviceaccounts

#First, let’s verify your service account iam-test exists

kubectl get sa iam-test

#Make sure your service account with the ARN of the IAM role is annotated

kubectl describe sa iam-test

#Let’s start by testing if the service account can list the S3 buckets

mkdir ~/environment/irsa

cat <<EoF> ~/environment/irsa/job-s3.yaml
apiVersion: batch/v1
kind: Job
metadata:
  name: eks-iam-test-s3
spec:
  template:
    metadata:
      labels:
        app: eks-iam-test-s3
    spec:
      serviceAccountName: iam-test
      containers:
      - name: eks-iam-test
        image: amazon/aws-cli:latest
        args: ["s3", "ls"]
      restartPolicy: Never
EoF

kubectl apply -f ~/environment/irsa/job-s3.yaml

#Make sure your job is completed

kubectl get job -l app=eks-iam-test-s3

#Now Let’s confirm that the service account cannot list the EC2 instances

cat <<EoF> ~/environment/irsa/job-ec2.yaml
apiVersion: batch/v1
kind: Job
metadata:
  name: eks-iam-test-ec2
spec:
  template:
    metadata:
      labels:
        app: eks-iam-test-ec2
    spec:
      serviceAccountName: iam-test
      containers:
      - name: eks-iam-test
        image: amazon/aws-cli:latest
        args: ["ec2", "describe-instances", "--region", "${AWS_REGION}"]
      restartPolicy: Never
  backoffLimit: 0
EoF

kubectl apply -f ~/environment/irsa/job-ec2.yaml

#Let’s verify the job status

kubectl get job -l app=eks-iam-test-ec2

#Finally we will review the logs

kubectl logs -l app=eks-iam-test-ec2


